@model IEnumerable<WedNightFury.Models.Order>

@{
    ViewData["Title"] = "Lá»™ trÃ¬nh hÃ´m nay";
    Layout = "~/Views/Shared/_LayoutDriver.cshtml";

    int index = 1;  // Äáº¿m thá»© tá»± giao
}

<style>
    .order-card {
        border-radius: 12px;
        border: none;
        padding: 20px;
        transition: 0.2s;
    }

    .order-card:hover {
        transform: scale(1.01);
        box-shadow: 0px 4px 16px rgba(0,0,0,0.1);
    }

    .order-card.suggested {
        border: 2px solid #28a745;
    }

    .order-number {
        font-size: 22px;
        font-weight: bold;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 12px;
    }

    .info-label {
        font-weight: 600;
        color: #555;
    }
</style>

<div class="container">

    <h3 class="fw-bold mb-4">
        ğŸ“ Lá»™ trÃ¬nh giao hÃ ng hÃ´m nay
        <span class="badge bg-success ms-2">Sáº¯p xáº¿p theo thá»© tá»± Ä‘á» xuáº¥t</span>
    </h3>

    @if (!Model.Any())
    {
        <div class="alert alert-info shadow-sm">
            HÃ´m nay báº¡n chÆ°a cÃ³ Ä‘Æ¡n nÃ o cáº§n giao.
        </div>
    }
    else
    {
        <!-- NÃºt cho nhiá»u Ä‘Æ¡n -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button type="button" id="btnStartMulti" class="btn btn-primary">
                ğŸš€ Báº¯t Ä‘áº§u giao cÃ¡c Ä‘Æ¡n Ä‘Ã£ chá»n
            </button>
            <small class="text-muted">
                Chá»n nhiá»u Ä‘Æ¡n á»Ÿ checkbox bÃªn trÃ¡i, há»‡ thá»‘ng sáº½ má»Ÿ Google Maps tá»‘i Æ°u lá»™ trÃ¬nh.
            </small>
        </div>

        @foreach (var o in Model)
        {
            // Chuáº©n hÃ³a Ä‘á»‹a chá»‰ Ä‘á»ƒ má»Ÿ Google Maps
            var address = o.ReceiverAddress ?? "";
            var fullAddress = string.IsNullOrWhiteSpace(address)
                ? "Viá»‡t Nam"
                : address + ", Viá»‡t Nam";
            var encoded = System.Uri.EscapeDataString(fullAddress);

            bool isFirst = (index == 1); // Ä‘Æ¡n Ä‘áº§u tiÃªn lÃ  gá»£i Ã½

            <div class="order-card shadow-sm bg-white mb-4 @(isFirst ? "suggested" : "")"
                 data-order-id="@o.Id">

                <!-- Header: Thá»© tá»± + TÃªn Ä‘Æ¡n -->
                <div class="d-flex justify-content-between align-items-center">

                    <div class="d-flex align-items-center">
                        <!-- Thá»© tá»± giao -->
                        <div class="order-number @(isFirst ? "bg-success" : "")">
                            @index
                        </div>

                        <!-- Checkbox -->
                        <div class="form-check me-2">
                            <input class="form-check-input order-select"
                                   type="checkbox"
                                   value="@o.Id"
                                   data-address="@fullAddress" />
                        </div>

                        <h5 class="fw-bold mb-0">
                            ÄÆ¡n: @o.Code
                            @if (isFirst)
                            {
                                <span class="badge bg-success ms-2">Gá»£i Ã½</span>
                            }
                        </h5>
                    </div>

                    <span class="badge 
                        @(o.Status == "pending"  ? "bg-warning text-dark" :
                          o.Status == "shipping" ? "bg-primary" :
                          o.Status == "done"     ? "bg-success" : "bg-danger")">
                        @o.Status?.ToUpper()
                    </span>
                </div>

                <hr />

                <div class="row">
                    <div class="col-md-6 mb-2">
                        <p><span class="info-label">ğŸ‘¤ NgÆ°á»i nháº­n:</span> @o.ReceiverName</p>
                        <p><span class="info-label">ğŸ“ SÄT:</span> @o.ReceiverPhone</p>
                        <p><span class="info-label">ğŸ“ Äá»‹a chá»‰:</span> @o.ReceiverAddress</p>
                    </div>

                    <div class="col-md-6 mb-2">
                        <p><span class="info-label">ğŸ“¦ Sáº£n pháº©m:</span> @o.ProductName</p>
                        <p><span class="info-label">âš– CÃ¢n náº·ng:</span> @o.Weight kg</p>
                        <p><span class="info-label">ğŸ’° COD:</span> @o.CodAmount.ToString("N0") Ä‘</p>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="mt-3">
                    <a asp-controller="Trip"
                       asp-action="StopDetail"
                       asp-route-id="@o.Id"
                       class="btn btn-sm btn-primary">
                        ğŸš€ Báº¯t Ä‘áº§u giao
                    </a>

                    <a class="btn btn-sm btn-outline-dark"
                       target="_blank"
                       href="https://www.google.com/maps/dir/?api=1&destination=@encoded">
                        ğŸ—º Báº£n Ä‘á»“
                    </a>

                    <a asp-controller="Trip"
                       asp-action="StopDetail"
                       asp-route-id="@o.Id"
                       class="btn btn-sm btn-outline-secondary">
                        ğŸ“„ Chi tiáº¿t
                    </a>
                </div>
            </div>

            index++; // tÄƒng thá»© tá»±
        }
    }
</div>

@section Scripts {
    <script>
        // Táº¡o route nhiá»u Ä‘iá»ƒm cho Google Maps
        document.getElementById("btnStartMulti").addEventListener("click", function () {

            const selected = Array.from(document.querySelectorAll(".order-select:checked"));
            if (selected.length === 0) {
                alert("Vui lÃ²ng chá»n Ã­t nháº¥t 1 Ä‘Æ¡n!");
                return;
            }

            const addresses = selected.map(el => encodeURIComponent(el.dataset.address));

            let url = "https://www.google.com/maps/dir/?api=1&destination=" + addresses[0];

            if (addresses.length > 1) {
                url += "&waypoints=optimize:true|" + addresses.slice(1).join("|");
            }

            window.open(url, "_blank");
        });
    </script>
}
