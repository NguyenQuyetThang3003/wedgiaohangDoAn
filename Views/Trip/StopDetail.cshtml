@model WedNightFury.Models.Order

@{
    // Layout d√†nh cho t√†i x·∫ø
    Layout = "_LayoutDriver";

    ViewData["Title"] = $"ƒêi·ªÉm giao - {Model.Code}";

    decimal ship  = Model.ShipFee;
    decimal cod   = Model.CodAmount;
    string payer  = Model.ShipPayer ?? "receiver";

    // T·ªïng ti·ªÅn t√†i x·∫ø THU T·ª™ KH√ÅCH
    decimal totalCollect = 0;
    if (cod <= 0)
    {
        // Kh√¥ng COD
        totalCollect = (payer == "receiver") ? ship : 0;
    }
    else
    {
        // C√≥ COD
        totalCollect = (payer == "receiver") ? ship + cod : cod;
    }

    // Ti·ªÅn t√†i x·∫ø ph·∫£i n·ªôp (ti·ªÅn h√†ng)
    decimal driverDeposit = cod > 0 ? cod : 0;

    string shipPayerText = payer == "sender" ? "Ng∆∞·ªùi g·ª≠i" : "Ng∆∞·ªùi nh·∫≠n";

    // ===========================
    // MAP ‚Äì d√πng ƒë·ªãa ch·ªâ kh√°ch
    // ===========================
    string rawAddress  = Model.ReceiverAddress ?? "";
    string fullAddress = string.IsNullOrWhiteSpace(rawAddress)
        ? "Vi·ªát Nam"
        : rawAddress + ", Vi·ªát Nam";  // th√™m country cho ch·∫Øc

    string encodedAddress = Uri.EscapeDataString(fullAddress);
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
    .box {
        background:#fff;
        padding:25px;
        border-radius:15px;
        box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    .label { width:160px; font-weight:600; color:#555; }
    .val { font-weight:600; }
    .btn-big { padding:12px 25px; border-radius:12px; font-size:17px; }
    .timeline { border-left:3px solid #d32f2f; margin-left:15px; padding-left:20px; }
    .tl-item { margin-bottom:15px; }
</style>

<div class="box mb-4">
    <h3 class="fw-bold text-danger mb-3">
        üì¶ ƒêI·ªÇM GIAO: @Model.Code
    </h3>

    <!-- Timeline -->
    <div class="timeline mb-4">
        <div class="tl-item">
            <strong>üìå T·∫°o ƒë∆°n:</strong>
            @Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm")
        </div>

        @if (Model.AssignedAt.HasValue)
        {
            <div class="tl-item">
                <strong>üöö ƒêang giao l√∫c:</strong>
                @Model.AssignedAt?.ToString("dd/MM/yyyy HH:mm")
            </div>
        }

        @if (Model.Status == "done" && Model.DeliveredAt.HasValue)
        {
            <div class="tl-item">
                <strong>‚úî Giao th√†nh c√¥ng:</strong>
                @Model.DeliveredAt?.ToString("dd/MM/yyyy HH:mm")
            </div>
        }

        @if (Model.Status == "failed" && Model.FailedAt.HasValue)
        {
            <div class="tl-item">
                <strong>‚úñ Giao th·∫•t b·∫°i:</strong>
                @Model.FailedAt?.ToString("dd/MM/yyyy HH:mm")
            </div>
        }
    </div>

    <!-- Th√¥ng tin ƒë∆°n -->
    <div class="d-flex mb-2">
        <div class="label">Ng∆∞·ªùi nh·∫≠n:</div>
        <div class="val">@Model.ReceiverName</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">SƒêT:</div>
        <div class="val">@Model.ReceiverPhone</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">ƒê·ªãa ch·ªâ:</div>
        <div class="val">@rawAddress</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">Gi√° tr·ªã h√†ng:</div>
        <div class="val">@Model.Value.ToString("N0") ƒë</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">COD:</div>
        <div class="val">@Model.CodAmount.ToString("N0") ƒë</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">Ph√≠ ship:</div>
        <div class="val">@Model.ShipFee.ToString("N0") ƒë</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">Ng∆∞·ªùi tr·∫£ ship:</div>
        <div class="val">@shipPayerText</div>
    </div>

    <hr />

    <div class="d-flex mb-2">
        <div class="label">Kh√°ch ph·∫£i tr·∫£:</div>
        <div class="val text-danger">@totalCollect.ToString("N0") ƒë</div>
    </div>

    <div class="d-flex mb-2">
        <div class="label">T√†i x·∫ø ph·∫£i n·ªôp:</div>
        <div class="val text-primary">@driverDeposit.ToString("N0") ƒë</div>
    </div>

    @* TR·∫†NG TH√ÅI COD CHO T√ÄI X·∫æ *@
    @if (cod > 0)
    {
        <div class="d-flex mb-2">
            <div class="label">Tr·∫°ng th√°i COD:</div>
            <div class="val">
                @if (Model.IsCodPaid)
                {
                    <span class="text-success fw-bold">
                        ƒê√É THU COD
                        @if (Model.CodPaidAt.HasValue)
                        {
                            @($" (l√∫c {Model.CodPaidAt:dd/MM/yyyy HH:mm})")
                        }
                    </span>
                }
                else
                {
                    <span class="text-danger fw-bold">CH∆ØA THU COD</span>
                }
            </div>
        </div>
    }
</div>

<!-- B·∫£n ƒë·ªì giao h√†ng -->
<div class="box mb-4" style="padding:15px 15px 5px 15px;">
    <h5 class="fw-bold mb-2">üó∫ B·∫£n ƒë·ªì giao h√†ng</h5>

    <iframe
        width="100%"
        height="320"
        style="border:0; border-radius:12px;"
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
        src="https://www.google.com/maps?q=@encodedAddress&output=embed">
    </iframe>
</div>

<!-- N·∫øu c√≥ COD v√† ng∆∞·ªùi tr·∫£ l√† ng∆∞·ªùi nh·∫≠n -> y√™u c·∫ßu t√†i x·∫ø x√°c nh·∫≠n ƒë√£ thu COD tr∆∞·ªõc khi b·∫•m POD -->
@if (cod > 0 && payer == "receiver" && !Model.IsCodPaid)
{
    <div class="box mb-3">
        <h5 class="fw-bold mb-2">üí∞ X√°c nh·∫≠n thu COD</h5>
        <p class="mb-2">
            S·ªë ti·ªÅn COD c·∫ßn thu t·ª´ kh√°ch:
            <span class="fw-bold text-danger">@cod.ToString("N0") ƒë</span>
        </p>

        <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   id="confirmCodCheckbox" />
            <label class="form-check-label fw-semibold" for="confirmCodCheckbox">
                T√¥i x√°c nh·∫≠n ƒë√£ thu ƒë·ªß COD t·ª´ kh√°ch.
            </label>
        </div>
    </div>
}

<!-- N√∫t thao t√°c -->
<div class="d-flex flex-wrap gap-3 mb-4">

    <!-- G·ªçi kh√°ch -->
    <a href="tel:@Model.ReceiverPhone"
       class="btn btn-outline-primary btn-big fw-bold">
        ‚òé G·ªçi kh√°ch
    </a>

    <!-- Nh·∫Øn Zalo -->
    @if (!string.IsNullOrWhiteSpace(Model.ReceiverPhone))
    {
        <a href="https://zalo.me/@Model.ReceiverPhone"
           target="_blank"
           class="btn btn-outline-info btn-big fw-bold">
            üí¨ Nh·∫Øn Zalo
        </a>
    }

    <!-- ƒêi·ªÅu h∆∞·ªõng: d√πng ƒë·ªãa ch·ªâ tr√™n ƒë∆°n -->
    <a class="btn btn-outline-dark btn-big fw-bold"
       target="_blank"
       href="https://www.google.com/maps/dir/?api=1&destination=@encodedAddress">
        üìç ƒêi·ªÅu h∆∞·ªõng
    </a>

    <!-- ƒê√£ giao (POD) ‚Äì n·∫øu c·∫ßn x√°c nh·∫≠n COD th√¨ disable t·ªõi khi tick -->
    @if (cod > 0 && payer == "receiver" && !Model.IsCodPaid)
    {
        <a asp-controller="Taixe"
           asp-action="Delivered"
           asp-route-id="@Model.Id"
           id="btnDelivered"
           class="btn btn-success btn-big fw-bold disabled"
           aria-disabled="true">
            ‚úî ƒê√£ giao (POD)
        </a>
    }
    else
    {
        <a asp-controller="Taixe"
           asp-action="Delivered"
           asp-route-id="@Model.Id"
           class="btn btn-success btn-big fw-bold">
            ‚úî ƒê√£ giao (POD)
        </a>
    }

    <!-- Giao th·∫•t b·∫°i ‚Äì c≈©ng x·ª≠ l√Ω b√™n Taixe -->
    <a asp-controller="Taixe"
       asp-action="Failed"
       asp-route-id="@Model.Id"
       class="btn btn-danger btn-big fw-bold">
        ‚úñ Giao th·∫•t b·∫°i
    </a>

    <!-- N√öT GHI NH·∫¨N ƒê√É THU COD (G·ªåI ConfirmCOD) -->
    @if (cod > 0)
    {
        if (!Model.IsCodPaid)
        {
            <a asp-controller="Taixe"
               asp-action="ConfirmCOD"
               asp-route-id="@Model.Id"
               class="btn btn-warning btn-big fw-bold">
                üí∞ X√ÅC NH·∫¨N ƒê√É THU COD
            </a>
        }
        else
        {
            <button type="button"
                    class="btn btn-outline-success btn-big fw-bold"
                    disabled>
                üí∞ ƒê√É THU COD
            </button>
        }
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var checkbox = document.getElementById("confirmCodCheckbox");
            var btnDelivered = document.getElementById("btnDelivered");

            if (checkbox && btnDelivered) {
                // Kh·ªüi t·∫°o: ch∆∞a tick -> disable
                btnDelivered.classList.add("disabled");
                btnDelivered.setAttribute("aria-disabled", "true");

                checkbox.addEventListener("change", function () {
                    if (this.checked) {
                        btnDelivered.classList.remove("disabled");
                        btnDelivered.removeAttribute("aria-disabled");
                    } else {
                        btnDelivered.classList.add("disabled");
                        btnDelivered.setAttribute("aria-disabled", "true");
                    }
                });
            }
        });
    </script>
}
