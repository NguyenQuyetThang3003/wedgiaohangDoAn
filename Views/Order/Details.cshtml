@model WedNightFury.Models.Order

@{
    ViewData["Title"] = "Chi ti·∫øt ƒë∆°n h√†ng";

    // T√≠nh to√°n ti·ªÅn cho t√†i x·∫ø thu
    decimal ship = Model.ShipFee;
    decimal cod  = Model.CodAmount;
    string payer = Model.ShipPayer ?? "receiver";

    // T·ªïng ti·ªÅn c·∫ßn thu kh√°ch
    decimal totalCollect = 0;

    if (cod <= 0)
    {
        // KH√îNG COD
        totalCollect = (payer == "receiver") ? ship : 0;
    }
    else
    {
        // C√ì COD
        totalCollect = (payer == "receiver") ? ship + cod : cod;
    }

    string shipPayerText = payer == "sender" ? "Ng∆∞·ªùi g·ª≠i" : "Ng∆∞·ªùi nh·∫≠n";
}

<div class="container py-4">
    <h3 class="mb-4 text-danger fw-bold">üì¶ Th√¥ng tin ƒë∆°n h√†ng #@Model.Id</h3>

    <div class="row">
        <!-- ====== C·ªôt tr√°i ====== -->
        <div class="col-md-6">
            <!-- Th√¥ng tin ƒë∆°n -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Th√¥ng tin ƒë∆°n</div>
                <div class="card-body">
                    <p>
                        <strong>M√£ ƒë∆°n h√†ng:</strong>
                        12300@Model.Id
                    </p>
                    <p>
                        <strong>Ng√†y t·∫°o:</strong>
                        @(Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "Ch∆∞a c√≥")
                    </p>
                    <p>
                        <strong>Tr·∫°ng th√°i:</strong>
                        @switch (Model.Status)
                        {
                            case "pending":
                                @:<span class="badge bg-info">Ch·ªù x·ª≠ l√Ω</span>
                                break;
                            case "shipping":
                                @:<span class="badge bg-warning text-dark">ƒêang v·∫≠n chuy·ªÉn</span>
                                break;
                            case "done":
                                @:<span class="badge bg-success">Ho√†n t·∫•t</span>
                                break;
                            case "failed":
                                @:<span class="badge bg-danger">Giao th·∫•t b·∫°i</span>
                                break;
                            case "cancelled":
                                @:<span class="badge bg-danger">ƒê√£ h·ªßy</span>
                                break;
                            default:
                                @:<span class="badge bg-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>
                                break;
                        }
                    </p>

                    <!-- Tr·∫°ng th√°i COD -->
                    <p>
                        <strong>Tr·∫°ng th√°i thanh to√°n COD:</strong>
                        @if (Model.CodAmount <= 0)
                        {
                            <span class="text-muted">ƒê∆°n kh√¥ng c√≥ COD</span>
                        }
                        else
                        {
                            if (Model.Status != "done")
                            {
                                <span class="text-danger fw-bold">
                                    Ch∆∞a giao &ndash; ch∆∞a thu COD
                                </span>
                            }
                            else if (!Model.IsCodPaid)
                            {
                                <span class="text-warning fw-bold">
                                    ƒê√£ giao &ndash; t√†i x·∫ø ch∆∞a ƒë·ªëi so√°t COD
                                </span>
                            }
                            else
                            {
                                <span class="text-success fw-bold">
                                    ƒê√£ ƒë·ªëi so√°t COD
                                    @if (Model.CodPaidAt.HasValue)
                                    {
                                        @($" l√∫c {Model.CodPaidAt:dd/MM/yyyy HH:mm}")
                                    }
                                </span>
                            }
                        }
                    </p>

                    <p>
                        <strong>Ghi ch√∫:</strong>
                        @(!string.IsNullOrEmpty(Model.Note) ? Model.Note : "Kh√¥ng c√≥")
                    </p>
                </div>
            </div>

            <!-- Ng∆∞·ªùi g·ª≠i -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Ng∆∞·ªùi g·ª≠i</div>
                <div class="card-body">
                    <p><strong>H·ªç t√™n:</strong> @Model.SenderName</p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> @Model.SenderPhone</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> @Model.SenderAddress</p>
                </div>
            </div>

            <!-- Ng∆∞·ªùi nh·∫≠n -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Ng∆∞·ªùi nh·∫≠n</div>
                <div class="card-body">
                    <p><strong>H·ªç t√™n:</strong> @Model.ReceiverName</p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> @Model.ReceiverPhone</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> @Model.ReceiverAddress</p>
                    <p><strong>T·ªânh/Th√†nh ph·ªë:</strong> @Model.Province</p>
                </div>
            </div>
        </div>

        <!-- ====== C·ªôt ph·∫£i ====== -->
        <div class="col-md-6">
            <!-- Th√¥ng tin h√†ng h√≥a + thanh to√°n -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">Th√¥ng tin h√†ng h√≥a & thanh to√°n</div>
                <div class="card-body">
                    <p><strong>T√™n h√†ng:</strong> @Model.ProductName</p>
                    <p><strong>Tr·ªçng l∆∞·ª£ng:</strong> @Model.Weight kg</p>
                    <p>
                        <strong>Gi√° tr·ªã khai b√°o:</strong>
                        @String.Format("{0:N0}", Model.Value) VNƒê
                    </p>
                    <p>
                        <strong>Ghi ch√∫ th√™m:</strong>
                        @(!string.IsNullOrEmpty(Model.Note) ? Model.Note : "Kh√¥ng c√≥")
                    </p>
                    <hr />

                    <p>
                        <strong>COD (ti·ªÅn h√†ng c·∫ßn thu h·ªô):</strong>
                        @String.Format("{0:N0}", Model.CodAmount) ƒë
                    </p>
                    <p>
                        <strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong>
                        <span class="text-danger fw-bold">
                            @String.Format("{0:N0}", Model.ShipFee) ƒë
                        </span>
                    </p>
                    <p>
                        <strong>Ng∆∞·ªùi tr·∫£ ph√≠ v·∫≠n chuy·ªÉn:</strong>
                        @shipPayerText
                    </p>

                    <hr />
                    <p class="mb-1">
                        <strong>T·ªîNG TI·ªÄN T√ÄI X·∫æ C·∫¶N THU KH√ÅCH:</strong>
                    </p>
                    <h4 class="text-danger fw-bold">
                        @totalCollect.ToString("N0") ƒë
                    </h4>
                    <small class="text-muted">
                        - N·∫øu kh√¥ng COD v√† ng∆∞·ªùi g·ª≠i tr·∫£ ship: t√†i x·∫ø kh√¥ng thu ti·ªÅn kh√°ch.<br />
                        - N·∫øu c√≥ COD v√† ng∆∞·ªùi nh·∫≠n tr·∫£ ship: thu ti·ªÅn h√†ng + ph√≠ ship.<br />
                        - N·∫øu c√≥ COD v√† ng∆∞·ªùi g·ª≠i tr·∫£ ship: ch·ªâ thu ti·ªÅn h√†ng.
                    </small>
                </div>
            </div>

            <!-- Ch·ª©ng t·ª´ giao h√†ng (POD) -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">
                    Ch·ª©ng t·ª´ giao h√†ng (POD)
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrWhiteSpace(Model.PodImagePath))
                    {
                        <div class="text-center">
                            <img src="@Model.PodImagePath"
                                 alt="·∫¢nh POD ƒë∆°n h√†ng @Model.Code"
                                 class="img-fluid rounded border mb-2"
                                 style="max-height:350px; object-fit:contain;" />

                            <div>
                                <a href="@Model.PodImagePath"
                                   target="_blank"
                                   class="btn btn-sm btn-outline-primary">
                                    Xem ·∫£nh k√≠ch th∆∞·ªõc l·ªõn
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        <span class="text-muted">
                            Ch∆∞a c√≥ ·∫£nh POD do t√†i x·∫ø t·∫£i l√™n.
                        </span>
                    }
                </div>
            </div>

            <!-- H√†nh tr√¨nh ƒë∆°n -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">H√†nh tr√¨nh ƒë∆°n</div>
                <div class="card-body">
                    <ul class="timeline list-unstyled">
                        <li>
                            <i class="bi bi-circle-fill text-success me-2"></i>
                            ƒê√£ t·∫°o ƒë∆°n h√†ng l√∫c @Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm")
                        </li>

                        @if (Model.Status == "shipping")
                        {
                            <li>
                                <i class="bi bi-truck text-primary me-2"></i>
                                ƒêang giao h√†ng
                            </li>
                        }
                        else if (Model.Status == "done")
                        {
                            <li>
                                <i class="bi bi-check-circle text-success me-2"></i>
                                ƒê√£ giao th√†nh c√¥ng
                            </li>
                        }
                        else if (Model.Status == "failed")
                        {
                            <li>
                                <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                                Giao th·∫•t b·∫°i
                            </li>
                        }
                        else if (Model.Status == "cancelled")
                        {
                            <li>
                                <i class="bi bi-x-circle text-danger me-2"></i>
                                ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy
                            </li>
                        }
                        else
                        {
                            <li>
                                <i class="bi bi-hourglass-split text-warning me-2"></i>
                                ƒêang ch·ªù x·ª≠ l√Ω
                            </li>
                        }
                    </ul>
                </div>
            </div>

            <!-- N√∫t thao t√°c -->
            <div class="d-flex gap-2 mt-3">
                <a asp-action="Manage" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Quay l·∫°i
                </a>
                <a asp-action="Print" asp-route-id="@Model.Id" class="btn btn-success">
                    <i class="bi bi-printer"></i> In ƒë∆°n
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline li {
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    .card {
        border-radius: 10px;
    }
    .card-header {
        font-size: 1rem;
    }
</style>
