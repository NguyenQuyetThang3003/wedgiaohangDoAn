@model WedNightFury.Models.Order
@{
    ViewData["Title"] = "Tạo đơn hàng - NightFury Express";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-5">
    <h2 class="text-center text-danger fw-bold mb-4">
        <i class="bi bi-truck"></i> TẠO ĐƠN HÀNG NIGHTFURY
    </h2>

    <form asp-action="Create" method="post">
        @Html.AntiForgeryToken()

        <!-- NGƯỜI GỬI -->
        <div class="card p-3 mb-4">
            <h5>NGƯỜI GỬI</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Tên người gửi</label>
                    <input asp-for="SenderName" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label>Số điện thoại</label>
                    <input asp-for="SenderPhone" class="form-control" />
                </div>
                <div class="col-md-12">
                    <label>Địa chỉ gửi</label>
                    <input asp-for="SenderAddress" class="form-control" />
                </div>
            </div>
        </div>

        <!-- NGƯỜI NHẬN -->
        <div class="card p-3 mb-4">
            <h5>NGƯỜI NHẬN</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Tên người nhận</label>
                    <input asp-for="ReceiverName" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label>SĐT người nhận</label>
                    <input asp-for="ReceiverPhone" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Tỉnh/Thành phố</label>
                    <select id="province" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label>Quận/Huyện</label>
                    <select id="district" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label>Phường/Xã</label>
                    <select id="ward" class="form-select"></select>
                </div>

                <div class="col-md-12">
                    <label>Địa chỉ chi tiết</label>
                    <input asp-for="ReceiverAddress" id="DetailAddress" class="form-control" />
                </div>
            </div>
        </div>

        <!-- HÀNG HÓA -->
        <div class="card p-3 mb-4">
            <h5>HÀNG HÓA</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Tên hàng</label>
                    <input asp-for="ProductName" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Trọng lượng (gram)</label>
                    <input asp-for="Weight" id="Weight" type="number" class="form-control" oninput="calculateShipping()" />
                </div>

                <div class="col-md-4">
                    <label>Giá trị (VNĐ)</label>
                    <input id="Value" class="form-control"
                           oninput="formatCurrency(this); document.getElementById('ValueHidden').value=this.value.replace(/\D/g,'');" />
                </div>

                <div class="col-md-4">
                    <label>Kích thước (Dài)</label>
                    <input id="length" type="number" class="form-control" oninput="calculateShipping()" />
                </div>

                <div class="col-md-4">
                    <label>Rộng</label>
                    <input id="width" type="number" class="form-control" oninput="calculateShipping()" />
                </div>

                <div class="col-md-4">
                    <label>Cao</label>
                    <input id="height" type="number" class="form-control" oninput="calculateShipping()" />
                </div>
            </div>
        </div>

        <!-- THANH TOÁN -->
        <div class="card p-3 mb-4">
            <h5>THANH TOÁN</h5>

            <div class="row g-3">
                <div class="col-md-4">
                    <label>Phí vận chuyển</label>
                    <input id="shipping-fee" class="form-control fw-bold text-danger" disabled />
                </div>

                <div class="col-md-4">
                    <label>COD</label>
                    <input id="codInput" type="text" class="form-control"
                           oninput="formatCurrency(this); document.getElementById('CodHidden').value=this.value.replace(/\D/g,'');" />

                    <div class="form-check mt-2">
                        <input id="codByValue" class="form-check-input" type="checkbox" onclick="useOrderValue()">
                        <label class="form-check-label">Thu bằng giá trị hàng</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <label>Ghi chú</label>
                    <textarea asp-for="Note" class="form-control"></textarea>
                </div>
            </div>
        </div>

        <!-- HIDDEN REAL VALUES -->
        <input type="hidden" id="ShipFeeHidden" name="ShipFee" />
        <input type="hidden" id="CodHidden" name="CodAmount" />
        <input type="hidden" id="ValueHidden" name="Value" />

        <input type="hidden" id="ProvinceHidden" name="Province" />
        <input type="hidden" id="DistrictHidden" name="District" />
        <input type="hidden" id="WardHidden" name="Ward" />

        <!-- SUBMIT -->
        <div class="text-center">
            <button type="submit" class="btn btn-danger btn-lg px-5">GỬI NGAY</button>
        </div>

    </form>
</div>

<script>
    // format tiền
    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, "");
        input.value = value ? new Intl.NumberFormat("vi-VN").format(value) : "";
    }

    // COD theo giá trị hàng
    function useOrderValue() {
        let v = document.getElementById("Value").value.replace(/\D/g, "");
        document.getElementById("codInput").value = new Intl.NumberFormat("vi-VN").format(v);
        document.getElementById("CodHidden").value = v;
    }

    // Tải tỉnh/huyện/xã
    let provinces = [];
    fetch("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json")
        .then(res => res.json())
        .then(data => { provinces = data; loadProvinces(); });

    function loadProvinces() {
        let p = document.getElementById("province");
        p.innerHTML = `<option value="">--Chọn--</option>`;
        provinces.forEach(x => p.innerHTML += `<option value="${x.Id}">${x.Name}</option>`);

        p.onchange = () => {
            document.getElementById("ProvinceHidden").value = p.options[p.selectedIndex].text.trim();
            loadDistricts();
        };
    }

    function loadDistricts() {
        let did = document.getElementById("district");
        let pid = document.getElementById("province").value;

        did.innerHTML = `<option value="">--Chọn--</option>`;
        document.getElementById("DistrictHidden").value = "";

        if (!pid) return;

        provinces.find(x => x.Id == pid).Districts.forEach(d =>
            did.innerHTML += `<option value="${d.Id}">${d.Name}</option>`
        );

        did.onchange = () => {
            document.getElementById("DistrictHidden").value = did.options[did.selectedIndex].text.trim();
            loadWards();
        };
    }

    function loadWards() {
        let wid = document.getElementById("ward");
        let did = document.getElementById("district").value;
        let pid = document.getElementById("province").value;

        wid.innerHTML = `<option value="">--Chọn--</option>`;
        document.getElementById("WardHidden").value = "";

        if (!pid || !did) return;

        let district = provinces.find(x => x.Id == pid).Districts.find(d => d.Id == did);

        district.Wards.forEach(w =>
            wid.innerHTML += `<option value="${w.Id}">${w.Name}</option>`
        );

        wid.onchange = () => {
            document.getElementById("WardHidden").value = wid.options[wid.selectedIndex].text.trim();
        };
    }

    // Tính ship fee
    function calculateShipping() {
        let w = +document.getElementById("Weight").value || 0;
        let d = +document.getElementById("length").value || 0;
        let r = +document.getElementById("width").value || 0;
        let c = +document.getElementById("height").value || 0;

        if (!w && !d && !r && !c) return;

        let vol = (d * r * c) / 6000 * 1000;
        let cw = Math.max(w, vol);

        let base = cw <= 500 ? 25000 :
                   cw <= 1000 ? 35000 :
                   35000 + Math.ceil((cw - 1000) / 500) * 5000;

        document.getElementById("shipping-fee").value =
            new Intl.NumberFormat("vi-VN").format(base) + " đ";

        document.getElementById("ShipFeeHidden").value = base;
    }
</script>
