@model WedNightFury.Models.Order
@{
    ViewData["Title"] = "Tạo đơn hàng - NightFury Express";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-5">
    <h2 class="text-center text-danger fw-bold mb-4">
        <i class="bi bi-truck"></i> TẠO ĐƠN HÀNG NIGHTFURY
    </h2>

    @* THÔNG BÁO TỪ VNPAY / MOMO / TẠO ĐƠN *@
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success text-center">
            @TempData["Success"]
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger text-center">
            @TempData["Error"]
        </div>
    }

    <form asp-action="Create" method="post" id="orderForm">
        @Html.AntiForgeryToken()

        <!-- 1. NGƯỜI GỬI -->
        <div class="card p-3 mb-4">
            <h5>1. NGƯỜI GỬI</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Tên người gửi</label>
                    <input asp-for="SenderName" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label>Số điện thoại</label>
                    <input asp-for="SenderPhone" class="form-control" />
                </div>
                <div class="col-md-12">
                    <label>Địa chỉ gửi</label>
                    <input asp-for="SenderAddress" class="form-control" />
                </div>
            </div>
        </div>

        <!-- 2. NGƯỜI NHẬN -->
        <div class="card p-3 mb-4">
            <h5>2. NGƯỜI NHẬN</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Tên người nhận</label>
                    <input asp-for="ReceiverName" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label>SĐT người nhận</label>
                    <input asp-for="ReceiverPhone" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Tỉnh/Thành phố</label>
                    <select id="province" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label>Quận/Huyện</label>
                    <select id="district" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label>Phường/Xã</label>
                    <select id="ward" class="form-select"></select>
                </div>

                <div class="col-md-12">
                    <label>Địa chỉ chi tiết</label>
                    <input asp-for="ReceiverAddress" id="DetailAddress" class="form-control" />
                </div>
            </div>
        </div>

        <!-- 3. THÔNG TIN HÀNG HÓA -->
        <div class="card p-3 mb-4">
            <h5>3. THÔNG TIN HÀNG HÓA</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Tên hàng</label>
                    <input asp-for="ProductName" class="form-control" />
                </div>

                <div class="col-md-4">
                    <label>Loại hàng</label>
                    <select name="GoodsType" class="form-select">
                        <option value="">-- Chọn loại hàng --</option>
                        <option value="document">Tài liệu / Hồ sơ</option>
                        <option value="normal">Hàng thông thường</option>
                        <option value="fragile">Hàng dễ vỡ</option>
                        <option value="electronic">Điện tử / Giá trị cao</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Khối lượng (kg)</label>
                    <input asp-for="Weight" id="Weight" type="number" step="0.1" min="0"
                           class="form-control" oninput="calculateShipping()" />
                    <small class="text-muted">Ví dụ: 1.5 kg</small>
                </div>

                <div class="col-md-4 mt-3">
                    <label>Giá trị hàng (COD) (VNĐ)</label>
                    <input id="Value" class="form-control"
                           oninput="formatCurrency(this);
                                    document.getElementById('ValueHidden').value=this.value.replace(/\\D/g,'');" />
                    <small class="text-muted">Nếu không COD thì để trống hoặc 0.</small>
                </div>

                <div class="col-md-8 mt-3">
                    <label>Ghi chú</label>
                    <textarea asp-for="Note" class="form-control"></textarea>
                </div>
            </div>
        </div>

        <!-- 4–7. CẤU HÌNH GIAO HÀNG -->
        <div class="card p-3 mb-4">
            <h5>4. CẤU HÌNH GIAO HÀNG</h5>

            <div class="row g-3">
                <!-- Khu vực: nội / ngoại thành -->
                <div class="col-md-4">
                    <label>Khu vực giao nhận</label>
                    <div class="btn-group d-flex" role="group" aria-label="Khu vực">
                        <input type="radio" name="AreaType" id="area-inner" value="inner"
                               class="btn-check" checked onchange="calculateShipping()" />
                        <label class="btn btn-outline-secondary w-50" for="area-inner">Nội thành</label>

                        <input type="radio" name="AreaType" id="area-outer" value="outer"
                               class="btn-check" onchange="calculateShipping()" />
                        <label class="btn btn-outline-secondary w-50" for="area-outer">Ngoại thành</label>
                    </div>
                </div>

                <!-- Phương thức gửi -->
                <div class="col-md-4">
                    <label>Phương thức gửi hàng</label>
                    <div class="btn-group d-flex" role="group" aria-label="Phương thức gửi">
                        <input type="radio" name="PickupMethod" id="pickup-staff" value="pickup"
                               class="btn-check" checked onchange="toggleHub();calculateShipping();" />
                        <label class="btn btn-outline-primary w-50" for="pickup-staff">Nhân viên lấy hàng</label>

                        <input type="radio" name="PickupMethod" id="pickup-hub" value="hub"
                               class="btn-check" onchange="toggleHub();calculateShipping();" />
                        <label class="btn btn-outline-primary w-50" for="pickup-hub">Tự đem đến hub</label>
                    </div>
                </div>

                <!-- Hub -->
                <div class="col-md-4" id="hub-wrapper">
                    <label>Chọn hub</label>
                    <select asp-for="DropoffHub" class="form-select" id="DropoffHub">
                        <option value="">-- Chọn hub --</option>
                        <option value="Hub Q1 - Nguyễn Huệ">Hub Q1 - Nguyễn Huệ</option>
                        <option value="Hub Q7 - Phú Mỹ Hưng">Hub Q7 - Phú Mỹ Hưng</option>
                        <option value="Hub Thủ Đức - Kha Vạn Cân">Hub Thủ Đức - Kha Vạn Cân</option>
                        <option value="Hub Bình Thạnh - Điện Biên Phủ">Hub Bình Thạnh - Điện Biên Phủ</option>
                    </select>
                    <small class="text-muted">Chỉ bắt buộc nếu bạn tự mang hàng ra hub.</small>
                </div>

                <!-- Mức dịch vụ -->
                <div class="col-md-6 mt-3">
                    <label>Mức dịch vụ</label>
                    <div class="btn-group d-flex" role="group" aria-label="Mức dịch vụ">
                        <input type="radio" name="ServiceLevel" id="sv-standard" value="standard"
                               class="btn-check" checked onchange="calculateShipping()" />
                        <label class="btn btn-outline-success w-100" for="sv-standard">Tiêu chuẩn</label>

                        <input type="radio" name="ServiceLevel" id="sv-fast" value="fast"
                               class="btn-check" onchange="calculateShipping()" />
                        <label class="btn btn-outline-success w-100" for="sv-fast">Nhanh</label>

                        <input type="radio" name="ServiceLevel" id="sv-express" value="express"
                               class="btn-check" onchange="calculateShipping()" />
                        <label class="btn btn-outline-success w-100" for="sv-express">Hỏa tốc</label>
                    </div>
                </div>

                <!-- Phí ship & COD -->
                <div class="col-md-3 mt-3">
                    <label>Phí vận chuyển dự kiến</label>
                    <input id="shipping-fee" class="form-control fw-bold text-danger" disabled />
                </div>

                <div class="col-md-3 mt-3">
                    <label>COD (tiền thu hộ)</label>
                    <input id="codInput" type="text" class="form-control"
                           oninput="formatCurrency(this);
                                    document.getElementById('CodHidden').value=this.value.replace(/\\D/g,'');
                                    updateSenderSummary();" />
                    <div class="form-check mt-2">
                        <input id="codByValue" class="form-check-input" type="checkbox" onclick="useOrderValue()">
                        <label class="form-check-label">Thu bằng giá trị hàng</label>
                    </div>
                </div>

                <!-- Ai trả ship -->
                <div class="col-md-3 mt-3">
                    <label>Ai trả phí vận chuyển?</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="ShipPayer"
                               id="payer-sender" value="sender" onchange="updateSenderSummary()">
                        <label class="form-check-label" for="payer-sender">Người gửi</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="ShipPayer"
                               id="payer-receiver" value="receiver" checked onchange="updateSenderSummary()">
                        <label class="form-check-label" for="payer-receiver">Người nhận</label>
                    </div>
                    <small class="text-muted">Mặc định: người nhận trả ship.</small>
                </div>

                <!-- CHỈ HIỂN THỊ PHẦN NGƯỜI GỬI QUAN TÂM -->
                <div class="col-md-3 mt-3">
                    <label>Phí ship người gửi chịu</label>
                    <input id="sender-ship-fee" class="form-control fw-bold" disabled />
                    <small class="text-muted">Nếu người nhận trả ship thì = 0.</small>
                </div>

                <div class="col-md-3 mt-3">
                    <label>Tổng tiền shop dự kiến nhận được</label>
                    <input id="sender-net" class="form-control fw-bold" disabled />
                    <small class="text-muted">
                        = Tiền hàng COD – phí ship shop chịu.
                    </small>

                    <!-- Nút thanh toán phí ship qua VNPay -->
                    <button type="submit"
                            class="btn btn-outline-danger w-100 mt-2"
                            id="btnVnPay"
                            formaction="@Url.Action("CreateAndPayVnPay", "Order")"
                            style="display:none;">
                        Thanh toán phí ship qua VNPay
                    </button>

                    <!-- Nút thanh toán phí ship qua MoMo -->
                    <button type="submit"
                            class="btn btn-outline-success w-100 mt-2"
                            id="btnMomo"
                            formaction="@Url.Action("CreateAndPayMomo", "Order")"
                            style="display:none;">
                        Thanh toán phí ship qua MoMo
                    </button>
                </div>

            </div>
        </div>

        <!-- HIDDEN REAL VALUES -->
        <input type="hidden" id="ShipFeeHidden" name="ShipFee" />
        <input type="hidden" id="CodHidden"   name="CodAmount" />
        <input type="hidden" id="ValueHidden" name="Value" />

        <input type="hidden" id="ProvinceHidden" name="Province" />
        <input type="hidden" id="DistrictHidden" name="District" />
        <input type="hidden" id="WardHidden"     name="Ward" />

        <div class="text-center">
            <button type="submit" class="btn btn-danger btn-lg px-5">GỬI NGAY</button>
        </div>
    </form>
</div>

<script>
    // --- City người gửi (từ Profile) để check nội/ngoại thành ---
    const senderCity = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.SenderCity ?? ""));

    // --------- FORMAT TIỀN ---------
    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, "");
        input.value = value ? new Intl.NumberFormat("vi-VN").format(value) : "";
    }

    function useOrderValue() {
        let v = document.getElementById("Value").value.replace(/\D/g, "");
        document.getElementById("codInput").value =
            new Intl.NumberFormat("vi-VN").format(v);
        document.getElementById("CodHidden").value = v;
        updateSenderSummary();
    }

    // --------- ĐỊA GIỚI HÀNH CHÍNH ---------
    let provinces = [];
    fetch("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json")
        .then(res => res.json())
        .then(data => { provinces = data; loadProvinces(); });

    function loadProvinces() {
        let p = document.getElementById("province");
        p.innerHTML = `<option value="">--Chọn--</option>`;
        provinces.forEach(x => p.innerHTML += `<option value="${x.Id}">${x.Name}</option>`);

        p.onchange = () => {
            document.getElementById("ProvinceHidden").value =
                p.options[p.selectedIndex].text.trim();
            loadDistricts();
        };
    }

    function loadDistricts() {
        let did = document.getElementById("district");
        let pid = document.getElementById("province").value;

        did.innerHTML = `<option value="">--Chọn--</option>`;
        document.getElementById("DistrictHidden").value = "";

        if (!pid) return;

        provinces.find(x => x.Id == pid).Districts.forEach(d =>
            did.innerHTML += `<option value="${d.Id}">${d.Name}</option>`
        );

        did.onchange = () => {
            document.getElementById("DistrictHidden").value =
                did.options[did.selectedIndex].text.trim();
            loadWards();
        };
    }

    function loadWards() {
        let wid = document.getElementById("ward");
        let did = document.getElementById("district").value;
        let pid = document.getElementById("province").value;

        wid.innerHTML = `<option value="">--Chọn--</option>`;
        document.getElementById("WardHidden").value = "";

        if (!pid || !did) return;

        let district = provinces.find(x => x.Id == pid)
                                .Districts.find(d => d.Id == did);

        district.Wards.forEach(w =>
            wid.innerHTML += `<option value="${w.Id}">${w.Name}</option>`
        );

        wid.onchange = () => {
            document.getElementById("WardHidden").value =
                wid.options[wid.selectedIndex].text.trim();
        };
    }

    // --------- HUB ---------
    function toggleHub() {
        const hubWrap = document.getElementById("hub-wrapper");
        const methodInput =
            document.querySelector('input[name="PickupMethod"]:checked');
        if (!hubWrap) return;

        if (methodInput && methodInput.value === "hub") {
            hubWrap.style.display = "block";
        } else {
            hubWrap.style.display = "none";
            const hubSelect = document.getElementById("DropoffHub");
            if (hubSelect) hubSelect.value = "";
        }
    }

    // --------- TÍNH PHÍ VẬN CHUYỂN ---------
    function calculateShipping() {
        let w = parseFloat(
            (document.getElementById("Weight").value || "0").replace(",", ".")
        ) || 0;

        if (w <= 0) {
            document.getElementById("shipping-fee").value = "";
            document.getElementById("ShipFeeHidden").value = "";
            updateSenderSummary();
            return;
        }

        let areaInput = document.querySelector('input[name="AreaType"]:checked');
        let area = areaInput ? areaInput.value : "inner";

        let methodInput =
            document.querySelector('input[name="PickupMethod"]:checked');
        let method = methodInput ? methodInput.value : "pickup";

        let serviceInput =
            document.querySelector('input[name="ServiceLevel"]:checked');
        let service = serviceInput ? serviceInput.value : "standard";

        let basePerKg = area === "inner" ? 15000 : 20000;
        let fee = basePerKg * w;

        if (method === "pickup") {
            fee += 10000; // Nhân viên đến lấy hàng
        }

        let factor = 1.0;
        if (service === "fast")    factor = 1.2;
        if (service === "express") factor = 1.5;

        fee = Math.round(fee * factor);

        document.getElementById("shipping-fee").value =
            new Intl.NumberFormat("vi-VN").format(fee) + " đ";
        document.getElementById("ShipFeeHidden").value = fee;

        updateSenderSummary();
    }

    // --------- TỔNG TIỀN SHOP NHẬN ĐƯỢC & PHÍ SHIP SHOP CHỊU ---------
    function updateSenderSummary() {
        const shipRaw = document.getElementById("ShipFeeHidden").value || "0";
        const codRaw  = document.getElementById("CodHidden").value    || "0";

        const ship = parseInt(shipRaw, 10) || 0;
        const cod  = parseInt(codRaw, 10)  || 0;

        const payerInput =
            document.querySelector('input[name="ShipPayer"]:checked');
        const payer = payerInput ? payerInput.value : "receiver";

        let senderShip = 0;
        if (payer === "sender") {
            senderShip = ship;
        } else {
            senderShip = 0;
        }

        let net = 0;
        if (cod > 0) {
            net = cod - senderShip;
            if (net < 0) net = 0;
        } else {
            net = 0;
        }

        const senderShipInput = document.getElementById("sender-ship-fee");
        const senderNetInput  = document.getElementById("sender-net");
        const btnVnPay        = document.getElementById("btnVnPay");
        const btnMomo         = document.getElementById("btnMomo");

        if (senderShipInput) {
            senderShipInput.value = senderShip > 0
                ? new Intl.NumberFormat("vi-VN").format(senderShip) + " đ"
                : "0 đ";
        }
        if (senderNetInput) {
            senderNetInput.value = net > 0
                ? new Intl.NumberFormat("vi-VN").format(net) + " đ"
                : "0 đ";
        }

        // Hiển thị nút VNPay & MoMo: chỉ khi người gửi trả ship và ship > 0
        const showOnlinePay = (payer === "sender" && ship > 0);

        if (btnVnPay) {
            btnVnPay.style.display = showOnlinePay ? "block" : "none";
        }
        if (btnMomo) {
            btnMomo.style.display = showOnlinePay ? "block" : "none";
        }
    }

    // --------- VALIDATE NỘI / NGOẠI THÀNH ---------
    function validateArea(senderCityName, receiverProvinceName, area) {
        const s = (senderCityName       || "").trim().toLowerCase();
        const r = (receiverProvinceName || "").trim().toLowerCase();

        if (!s || !r) return { ok: true, message: "" };

        if (area === "inner" && s !== r) {
            return {
                ok: false,
                message:
                    "Bạn đang chọn khu vực 'Nội thành' nhưng tỉnh/TP người gửi (" +
                    senderCityName + ") khác tỉnh/TP người nhận (" +
                    receiverProvinceName +
                    "). Vui lòng chọn 'Ngoại thành'."
            };
        }

        if (area === "outer" && s === r) {
            return {
                ok: false,
                message:
                    "Bạn đang chọn khu vực 'Ngoại thành' nhưng người gửi và người nhận cùng tỉnh/TP (" +
                    senderCityName +
                    "). Vui lòng chọn 'Nội thành'."
            };
        }

        return { ok: true, message: "" };
    }

    // --------- INIT ---------
    document.addEventListener("DOMContentLoaded", function () {
        toggleHub();
        calculateShipping();
        updateSenderSummary();

        const form = document.getElementById("orderForm");
        if (form) {
            form.addEventListener("submit", function (e) {
                const provinceName =
                    document.getElementById("ProvinceHidden").value || "";
                const areaInput =
                    document.querySelector('input[name="AreaType"]:checked');
                const area = areaInput ? areaInput.value : "inner";

                const result = validateArea(senderCity, provinceName, area);
                if (!result.ok) {
                    e.preventDefault();
                    alert(result.message);
                }
            });
        }
    });
</script>
