@model WedNightFury.Models.ViewModels.AdminComplaintThreadViewModel

@{
    ViewData["Title"] = "Xem h·ªôi tho·∫°i h·ªó tr·ª£";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

    // Chu·∫©n b·ªã m·∫£ng d√≤ng reply (n·∫øu c√≥)
    var replyLines = string.IsNullOrWhiteSpace(Model.Reply)
        ? Array.Empty<string>()
        : Model.Reply.Split('\n');
}

<div class="container py-3" style="max-width: 900px;">
    <h2 class="mb-3">H·ªôi tho·∫°i h·ªó tr·ª£ v·ªõi t√†i x·∫ø</h2>

    <div class="mb-2 text-muted">
        T√†i x·∫ø:
        <span class="fw-semibold">@Model.DriverUserName</span>
        @if (!string.IsNullOrWhiteSpace(Model.DriverFullName))
        {
            <span class="text-muted">(@Model.DriverFullName)</span>
        }
    </div>

    <div class="mb-3">
        <span class="badge @(Model.Status == "replied" ? "bg-success" : "bg-warning text-dark")">
            @(Model.Status == "replied" ? "ƒê√£ tr·∫£ l·ªùi" : "Ch·ªù ph·∫£n h·ªìi")
        </span>
    </div>

    <!-- Y√äU C·∫¶U BAN ƒê·∫¶U -->
    <div class="card mb-3">
        <div class="card-header fw-semibold">
            üì© Y√™u c·∫ßu c·ªßa t√†i x·∫ø
        </div>
        <div class="card-body">
            <small class="text-muted d-block mb-2">
                <i class="bi bi-clock me-1"></i>
                @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")
            </small>
            <div class="p-3 bg-light rounded border">
                @Model.Message
            </div>
        </div>
    </div>

    <!-- LOG H·ªòI THO·∫†I + FORM SO·∫†N TIN -->
    <div class="card mb-3">
        <div class="card-header fw-semibold">
            üí¨ Tin nh·∫Øn trao ƒë·ªïi
        </div>
        <div class="card-body">
            @* Danh s√°ch tin nh·∫Øn *@
            @if (replyLines.Length == 0)
            {
                <div class="text-muted fst-italic mb-2">
                    Ch∆∞a c√≥ tin nh·∫Øn n√†o trong h·ªôi tho·∫°i n√†y.
                </div>
            }
            else
            {
                @foreach (var line in replyLines)
                {
                    var trimmed = line?.Trim() ?? "";
                    bool isDriver = trimmed.StartsWith("[Driver");
                    var alignmentClass = isDriver ? "justify-content-end" : "justify-content-start";
                    var bgColor = isDriver ? "#e7f1ff" : "#ffffff";

                    <div class="d-flex @alignmentClass mb-2">
                        <div class="p-2 rounded-3 border small"
                             style="max-width: 80%; white-space: pre-line; background-color:@bgColor;">
                            @trimmed
                        </div>
                    </div>
                }
            }

            @* Th√¥ng b√°o l·ªói n·∫øu c√≥ *@
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger mt-2 py-2 small">
                    @TempData["Error"]
                </div>
            }

            <hr class="mt-3" />

            @* FORM SO·∫†N TR·∫¢ L·ªúI M·ªöI *@
            <form asp-action="AddMessage" method="post" class="mt-2">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />

                <div class="mb-2">
                    <label class="form-label fw-semibold">So·∫°n tr·∫£ l·ªùi m·ªõi</label>
                    <textarea name="replyText"
                              class="form-control"
                              rows="3"
                              placeholder="Nh·∫≠p n·ªôi dung tr·∫£ l·ªùi cho t√†i x·∫ø..."></textarea>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">
                        G·ª≠i tr·∫£ l·ªùi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between">
        <a asp-action="Index" class="btn btn-secondary">
            ‚Üê Quay l·∫°i danh s√°ch
        </a>
        <a asp-action="Reply" asp-route-id="@Model.Id"
           class="btn btn-outline-primary">
            M·ªü trang tr·∫£ l·ªùi c≈©
        </a>
    </div>
</div>
