@model IEnumerable<WedNightFury.Models.Order>

@{
    ViewData["Title"] = "Kết quả tra cứu đơn hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var orders = Model?.ToList() ?? new List<WedNightFury.Models.Order>();
    string searchCode = ViewBag.SearchCode as string; // nếu controller có set
}

<div class="container py-4">

    <!-- Tiêu đề + nút tra cứu khác -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-primary mb-0">
            <i class="fas fa-clipboard-check"></i> Kết quả tra cứu
            @if (!string.IsNullOrWhiteSpace(searchCode))
            {
                <span class="fs-6 text-muted">
                    (&nbsp;mã: <strong>@searchCode</strong>&nbsp;)
                </span>
            }
        </h4>

        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Tra cứu khác
        </a>
    </div>

    @if (!orders.Any())
    {
        <!-- Không có kết quả -->
        <div class="alert alert-warning shadow-sm">
            Không tìm thấy đơn hàng nào
            @if (!string.IsNullOrWhiteSpace(searchCode))
            {
                @:với mã <strong>@searchCode</strong>.
            }
            else
            {
                @:phù hợp với thông tin tra cứu.
            }
            <br />
            Vui lòng kiểm tra lại mã đơn hoặc liên hệ bộ phận hỗ trợ.
        </div>
    }
    else
    {
        <!-- Thông tin tổng quan -->
        <div class="alert alert-info shadow-sm d-flex justify-content-between align-items-center mb-3">
            <div>
                Tìm thấy <strong>@orders.Count</strong> đơn hàng.
            </div>
            <small class="text-muted">
                Nhấn “Xem” để xem hành trình đơn, ảnh POD và trạng thái COD chi tiết.
            </small>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle shadow-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="min-width: 140px;">Mã đơn</th>
                        <th>Người gửi</th>
                        <th>Người nhận</th>
                        <th class="text-end">Giá trị (VNĐ)</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center">COD</th>
                        <th class="text-center">POD</th>
                        <th class="text-center">Ngày tạo</th>
                        <th class="text-center" style="width: 110px;"></th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var order in orders)
                {
                    // Badge trạng thái đơn
                    var statusClass =
                        order.Status == "pending"   ? "bg-info text-white" :
                        order.Status == "assigned"  ? "bg-primary text-white" :
                        order.Status == "shipping"  ? "bg-warning text-dark" :
                        order.Status == "done"      ? "bg-success text-white" :
                        order.Status == "failed"    ? "bg-danger text-white" :
                        order.Status == "cancelled" ? "bg-dark text-white" :
                                                      "bg-secondary text-white";

                    var statusText =
                        order.Status == "pending"   ? "Chờ xử lý" :
                        order.Status == "assigned"  ? "Đã phân công" :
                        order.Status == "shipping"  ? "Đang giao" :
                        order.Status == "done"      ? "Hoàn tất" :
                        order.Status == "failed"    ? "Giao thất bại" :
                        order.Status == "cancelled" ? "Đã hủy" :
                                                      order.Status;

                    // COD
                    string codLabel;
                    string codClass;
                    if (order.CodAmount <= 0)
                    {
                        codLabel = "Không COD";
                        codClass = "badge bg-secondary";
                    }
                    else if (order.IsCodPaid)
                    {
                        codLabel = "Đã thu COD";
                        codClass = "badge bg-success";
                    }
                    else if (order.Status == "done")
                    {
                        codLabel = "Chưa đối soát COD";
                        codClass = "badge bg-warning text-dark";
                    }
                    else
                    {
                        codLabel = "Chưa thu COD";
                        codClass = "badge bg-warning text-dark";
                    }

                    // POD (ảnh giao hàng)
                    bool hasPod = !string.IsNullOrWhiteSpace(order.PodImagePath);
                    string podTitle = hasPod ? "Đã có ảnh POD" : "Chưa có ảnh POD";
                <tr>
                    <td class="fw-bold">@order.Code</td>
                    <td>@order.SenderName</td>
                    <td>@order.ReceiverName</td>

                    <td class="text-end">
                        @order.Value.ToString("N0")
                    </td>

                    <td class="text-center">
                        <span class="badge @statusClass px-3">
                            @statusText
                        </span>
                    </td>

                    <td class="text-center">
                        <span class="@codClass">@codLabel</span>
                    </td>

                    <td class="text-center">
                        @if (hasPod)
                        {
                            <span class="text-success" title="@podTitle">
                                <i class="fas fa-image"></i>
                            </span>
                        }
                        else
                        {
                            <span class="text-muted" title="@podTitle">
                                <i class="far fa-image"></i>
                            </span>
                        }
                    </td>

                    <td class="text-center">
                        @order.CreatedAt?.ToString("dd/MM/yyyy HH:mm")
                    </td>

                    <td class="text-center">
                        <a asp-controller="Order"
                           asp-action="Details"
                           asp-route-id="@order.Id"
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Xem
                        </a>
                    </td>
                </tr>
                }
                </tbody>
            </table>
        </div>
    }
</div>

<style>
    .table-hover tbody tr:hover {
        background-color: #f8fbff;
    }
</style>
